version: '2'

services:
  llm_router_test:
    build: .
    volumes:
      - ../models/mock.json:/opt/llm_router_tests/mock.json
    depends_on:
      llm_router:
        condition: service_healthy
      cache:
        condition: service_healthy

  llm_router:
    build: 
      context: ../
      dockerfile: dockerfiles/Dockerfile.dev
    user: root
    ports:
      - "8000:8000"
    volumes:
      - ../models/mock.json:/opt/models/mock.json
    depends_on:
      cache:
        condition: service_healthy
    networks:
        default:
        internal:
    healthcheck:
      test: ["CMD", "curl", "http://0.0.0.0:8000/health"]
      start_period: 5s
      interval: 5s
      timeout: 5s
      retries: 55

  cache:
    image: redis:4
    restart: always
    volumes:
    - ../.data/redis:/data
    networks:
        internal:
    healthcheck:
      test: ["CMD", "redis-cli","ping"]
      start_period: 5s
      interval: 5s
      timeout: 5s
      retries: 55

networks:
    default:
    internal:
        internal: true